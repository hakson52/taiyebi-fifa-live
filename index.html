<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fresco Cup — FIFA Tournament Season 2</title>
  <link rel="icon" type="image/x-icon" href="assets/toloba-favicon.png">
  <link rel="apple-touch-icon" href="assets/favicon.ico">
  <style>
    :root{
      --bg:#080604;
      --card:#121008;
      --card2:#0E0C06;
      --line:rgba(212,168,67,.18);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.55);
      --accent:#D4A843;
      --accent2:#C49B3A;
      --gold-glow:rgba(212,168,67,.25);
      --good:#35D07F;
      --warn:#FFC857;
      --bad:#FF5A6E;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 500px at 15% 0%, rgba(212,168,67,.10), transparent 60%),
        radial-gradient(700px 400px at 85% 10%, rgba(196,155,58,.07), transparent 60%),
        radial-gradient(400px 400px at 50% 100%, rgba(212,168,67,.05), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:1400px;margin:0 auto;padding:22px}

    /* Hero Banner - Glamorous FIFA Style */
    .hero{
      position:relative;overflow:hidden;
      border-radius:24px;margin-bottom:20px;
      border:2px solid rgba(212,168,67,.4);
      background:linear-gradient(135deg, #0A0802 0%, #1A1508 25%, #0D0A04 50%, #1C1609 75%, #0A0802 100%);
      padding:32px 36px;
      display:flex;align-items:center;gap:28px;
      box-shadow: 
        0 0 30px rgba(212,168,67,.3),
        inset 0 1px 0 rgba(212,168,67,.2),
        0 8px 32px rgba(0,0,0,.4);
    }
    .hero::before{
      content:'';position:absolute;top:-60%;left:-20%;
      width:80%;height:220%;
      background:radial-gradient(ellipse, rgba(212,168,67,.12), rgba(212,168,67,.05) 40%, transparent 70%);
      pointer-events:none;animation:heroGlow 4s ease-in-out infinite alternate;
    }
    .hero::after{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:linear-gradient(45deg, transparent 45%, rgba(212,168,67,.1) 50%, transparent 55%);
      pointer-events:none;animation:heroShimmer 3s ease-in-out infinite;
    }
    @keyframes heroGlow {
      0% { transform: rotate(0deg) scale(1); opacity: 0.8; }
      100% { transform: rotate(5deg) scale(1.1); opacity: 1; }
    }
    @keyframes heroShimmer {
      0%, 100% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
    }
    
    .hero-decorative-left, .hero-decorative-right {
      position:absolute;top:50%;transform:translateY(-50%);
      width:80px;height:80px;opacity:0.15;
      animation:float 6s ease-in-out infinite;
    }
    .hero-decorative-left { left:20px; animation-delay:-2s; }
    .hero-decorative-right { right:20px; animation-delay:-4s; }
    @keyframes float {
      0%, 100% { transform:translateY(-50%) rotate(0deg); }
      50% { transform:translateY(-60%) rotate(180deg); }
    }
    
    .hero-stars {
      position:absolute;width:100%;height:100%;top:0;left:0;
      pointer-events:none;overflow:hidden;
    }
    .hero-star {
      position:absolute;
      width:4px;height:4px;
      background:radial-gradient(circle, #F5DCA0, #D4A843);
      border-radius:50%;
      animation:twinkle 2s ease-in-out infinite;
    }
    .hero-star:nth-child(1) { top:20%; left:15%; animation-delay:0s; }
    .hero-star:nth-child(2) { top:30%; left:85%; animation-delay:0.5s; }
    .hero-star:nth-child(3) { top:70%; left:10%; animation-delay:1s; }
    .hero-star:nth-child(4) { top:60%; left:90%; animation-delay:1.5s; }
    .hero-star:nth-child(5) { top:15%; left:75%; animation-delay:0.7s; }
    .hero-star:nth-child(6) { top:80%; left:25%; animation-delay:1.2s; }
    @keyframes twinkle {
      0%, 100% { opacity:0.3; transform:scale(1); }
      50% { opacity:1; transform:scale(1.5); }
    }
    
    .hero-logo{
      width:84px;height:84px;border-radius:22px;flex-shrink:0;
      background:linear-gradient(135deg, #F5DCA0 0%, #D4A843 30%, #B8952F 70%, #8B6914 100%);
      box-shadow:
        0 0 40px rgba(212,168,67,.5),
        0 8px 32px rgba(212,168,67,.3),
        inset 0 2px 4px rgba(255,255,255,.1),
        inset 0 -2px 4px rgba(0,0,0,.2);
      display:flex;align-items:center;justify-content:center;
      font-size:32px;font-weight:900;color:#080604;
      letter-spacing:-1px;
      overflow:hidden;
      position:relative;
      animation:logoGlow 3s ease-in-out infinite alternate;
    }
    .hero-logo::before {
      content:'';position:absolute;top:-50%;left:-50%;
      width:200%;height:200%;
      background:conic-gradient(from 0deg, transparent, rgba(255,255,255,.3), transparent);
      animation:logoRotate 4s linear infinite;
    }
    .hero-logo img {
      width:100%;height:100%;object-fit:contain;
      border-radius:22px;position:relative;z-index:2;
    }
    @keyframes logoGlow {
      0% { box-shadow: 0 0 40px rgba(212,168,67,.5), 0 8px 32px rgba(212,168,67,.3), inset 0 2px 4px rgba(255,255,255,.1), inset 0 -2px 4px rgba(0,0,0,.2); }
      100% { box-shadow: 0 0 60px rgba(212,168,67,.8), 0 12px 48px rgba(212,168,67,.5), inset 0 2px 4px rgba(255,255,255,.2), inset 0 -2px 4px rgba(0,0,0,.1); }
    }
    @keyframes logoRotate {
      0% { transform:rotate(0deg); }
      100% { transform:rotate(360deg); }
    }
    
    .hero-info{flex:1;min-width:0;position:relative;z-index:3}
    .hero-info h1{
      margin:0;font-size:26px;font-weight:900;letter-spacing:.8px;
      background:linear-gradient(135deg, #FFFFFF 0%, #F5DCA0 25%, #D4A843 50%, #F5DCA0 75%, #FFFFFF 100%);
      background-size:200% 200%;
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      background-clip:text;
      animation:titleShimmer 3s ease-in-out infinite;
      position:relative;
    }
    @keyframes titleShimmer {
      0%, 100% { background-position:0% 50%; }
      50% { background-position:100% 50%; }
    }
    
    .hero-info .hero-sub{
      margin:6px 0 0;font-size:14px;color:rgba(255,255,255,.85);letter-spacing:.4px;
      text-shadow:0 2px 8px rgba(0,0,0,.8);
      font-weight:500;
    }
    .hero-info .hero-sub b{
      color:var(--accent);
      text-shadow:0 0 10px rgba(212,168,67,.6);
      font-weight:700;
    }
    .hero-venue{
      margin:10px 0 0;font-size:12.5px;color:rgba(255,255,255,.65);
      letter-spacing:.4px;
      text-shadow:0 1px 4px rgba(0,0,0,.6);
    }
    .hero-badge{
      flex-shrink:0;padding:12px 20px;border-radius:30px;
      background:linear-gradient(135deg, rgba(212,168,67,.20) 0%, rgba(212,168,67,.12) 50%, rgba(212,168,67,.20) 100%);
      border:1px solid rgba(212,168,67,.3);
      box-shadow:0 0 12px rgba(212,168,67,.2);
      font-size:12px;color:#F5DCA0;letter-spacing:1px;text-transform:uppercase;font-weight:800;
      text-shadow:0 1px 2px rgba(0,0,0,.5);
    }
    .hero-right{
      display:flex;flex-direction:column;align-items:flex-end;gap:8px;
      flex-shrink:0;
    }
    .hero-status{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      font-size:12px;color:var(--muted);background:rgba(212,168,67,.03)
    }
    .hero-status b{color:var(--text)}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;border:1px solid var(--line);border-radius:16px;
      background:linear-gradient(180deg, rgba(212,168,67,.05), rgba(212,168,67,.01));
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .badge{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, #D4A843, #8B6914);
      box-shadow:0 6px 20px rgba(212,168,67,.25);
      display:flex;align-items:center;justify-content:center;
      font-size:14px;font-weight:900;color:#080604;
    }
    .title h1{margin:0;font-size:15px;letter-spacing:.3px;color:var(--accent)}
    .title p{margin:2px 0 0;color:var(--muted);font-size:12px}
    .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(212,168,67,.03)
    }
    label{color:var(--muted);font-size:12px}
    select, input{
      color:var(--text);
      background:linear-gradient(180deg, rgba(212,168,67,.08), rgba(0,0,0,.35));
      border:1px solid rgba(212,168,67,.28);
      padding:8px 12px;border-radius:12px;outline:none;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
    }
    select:focus, input:focus{
      border-color:rgba(212,168,67,.55);
      box-shadow:0 0 0 2px rgba(212,168,67,.12);
    }
    select option{
      background:#0B0904;
      color:var(--text);
    }
    .status{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      font-size:12px;color:var(--muted);background:rgba(212,168,67,.03)
    }
    .status b{color:var(--text)}
    .grid{
      display:grid;grid-template-columns: 1.25fr .75fr; gap:16px; margin-top:16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--line);border-radius:18px;
      background:linear-gradient(180deg, rgba(212,168,67,.04), rgba(212,168,67,.01));
      padding:14px;
    }
    .card h2{
      margin:0 0 10px;font-size:13px;letter-spacing:.8px;text-transform:uppercase;
      color:var(--accent);
      display:flex;align-items:center;justify-content:space-between
    }
    .subnote{color:var(--muted);font-size:12px;font-weight:400}
    .matches{
      display:grid;grid-template-columns:1fr 1fr; gap:12px;
    }
    @media (max-width: 640px){ .matches{grid-template-columns:1fr} }
    .match{
      background:rgba(0,0,0,.30);
      border:1px solid rgba(212,168,67,.12);
      border-radius:16px;padding:12px;
      display:flex;flex-direction:column;gap:10px;
      min-height:112px;
    }
    .match.playin{
      border-color:rgba(212,168,67,.22);
      background:rgba(212,168,67,.04);
    }
    .match.quarters{
      border-color:rgba(212,168,67,.30);
      background:rgba(212,168,67,.07);
      box-shadow:0 0 12px rgba(212,168,67,.12);
    }
    .match.semis{
      border-color:rgba(212,168,67,.45);
      background:rgba(212,168,67,.10);
      box-shadow:0 0 16px rgba(212,168,67,.18);
    }
    .match.final{
      border-color:rgba(212,168,67,.75);
      background:linear-gradient(135deg, rgba(212,168,67,.20), rgba(212,168,67,.08));
      box-shadow:0 0 20px rgba(212,168,67,.35);
    }
    .col .match{margin-bottom:10px}
    .col .match:last-child{margin-bottom:0}
    .stage-tabs{
      display:flex;flex-wrap:wrap;gap:10px;
      margin:16px 0;
      padding:10px 12px;border-radius:16px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(212,168,67,.05), rgba(212,168,67,.01));
    }
    .stage-tab{
      border:1px solid rgba(212,168,67,.18);
      background:rgba(212,168,67,.06);
      color:var(--text);
      padding:8px 14px;border-radius:999px;
      font-size:12px;letter-spacing:.6px;text-transform:uppercase;font-weight:700;
      cursor:pointer;
      transition:all .2s ease;
    }
    .stage-tab:hover{border-color:rgba(212,168,67,.35);background:rgba(212,168,67,.10)}
    .stage-tab.active{
      border-color:rgba(212,168,67,.75);
      background:linear-gradient(135deg, rgba(212,168,67,.25), rgba(212,168,67,.10));
      color:#F5DCA0;
      box-shadow:0 0 12px rgba(212,168,67,.25);
    }
    .stage-panel{display:none}
    .stage-panel.active{display:block}
    .card-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      flex-wrap:wrap;
    }
    .card-head .pill{margin-left:auto}
    .protected-list{
      display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 4px;
    }
    .protected-item{
      font-size:12px;color:var(--muted);
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(212,168,67,.18);
      background:rgba(212,168,67,.04);
    }
    .popup-overlay{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.65);
      backdrop-filter: blur(6px);
      z-index:999;
      padding:20px;
    }
    .popup-overlay.show{display:flex}
    .popup{
      position:relative;
      width:min(760px, 96vw);
      border-radius:24px;
      border:2px solid rgba(212,168,67,.6);
      background:linear-gradient(135deg, rgba(18,16,8,.95), rgba(12,10,4,.98));
      box-shadow:0 26px 70px rgba(0,0,0,.65), 0 0 60px rgba(212,168,67,.35);
      padding:36px 34px 28px;
      text-align:center;
      overflow:hidden;
    }
    .popup h3{
      margin:0 0 6px;
      font-size:24px;letter-spacing:1px;
      color:#F5DCA0;
      text-transform:uppercase;
    }
    .popup .winner{
      font-size:36px;font-weight:900;letter-spacing:.8px;
      color:#FFD770;
      margin:10px 0 8px;
    }
    .popup .runner{
      font-size:20px;color:#F5DCA0;font-weight:900;
      text-shadow:0 0 16px rgba(212,168,67,.45);
    }
    .popup-close{
      position:absolute;top:10px;right:10px;
      width:30px;height:30px;border-radius:999px;
      border:1px solid rgba(212,168,67,.35);
      background:rgba(212,168,67,.08);
      color:var(--text);cursor:pointer;
    }
    .confetti{
      position:absolute;inset:-10% 0 auto 0;height:140%;
      pointer-events:none;overflow:hidden;
    }
    .confetti span{
      position:absolute;top:-10%;
      width:10px;height:16px;
      background:var(--c, #F5DCA0);
      opacity:.9;border-radius:3px;
      animation:
        confettiFall var(--d, 3.4s) linear infinite,
        confettiSway var(--d2, 2.6s) ease-in-out infinite;
      transform:translateX(var(--x, 0)) rotate(var(--r, 0deg));
    }
    @keyframes confettiFall{
      0%{transform:translate(var(--x, 0), -20px) rotate(var(--r, 0deg))}
      100%{transform:translate(var(--x, 0), 520px) rotate(calc(var(--r, 0deg) + 260deg))}
    }
    @keyframes confettiSway{
      0%, 100%{margin-left:-8px}
      50%{margin-left:10px}
    }
    .match:hover{border-color:rgba(212,168,67,.25);background:rgba(0,0,0,.35)}
    .match-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .setup{
      font-size:12px;color:var(--accent);
      padding:6px 10px;border-radius:999px;border:1px solid rgba(212,168,67,.18);
      background:rgba(212,168,67,.06)
    }
    .roundtag{font-size:12px;color:var(--muted)}
    .row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:8px 10px;border-radius:14px;background:rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.05)
    }
    .name{font-weight:650;letter-spacing:.2px;display:flex;align-items:center;gap:6px}
    .winner-badge{
      font-size:10px;font-weight:900;letter-spacing:.6px;
      padding:2px 6px;border-radius:999px;
      border:1px solid rgba(212,168,67,.45);
      background:rgba(212,168,67,.12);
      color:#F5DCA0;
    }
    .score{
      font-variant-numeric: tabular-nums;
      font-weight:800;font-size:18px;
      padding:4px 10px;border-radius:12px;
      background:rgba(212,168,67,.10);
      border:1px solid rgba(212,168,67,.22);
      color:var(--accent);
      min-width:68px;text-align:center;
      transition:all 0.3s ease;
    }
    .score.dim{opacity:.45}

    /* Individual player scores */
    .individual-score {
      font-variant-numeric: tabular-nums;
      font-weight:800;font-size:24px;
      padding:4px 12px;border-radius:12px;
      background:rgba(212,168,67,.10);
      border:1px solid rgba(212,168,67,.22);
      color:var(--accent);
      min-width:48px;text-align:center;
      transition:all 0.3s ease;
    }

    /* Score Change Animations - Enhanced for more prominence */
    .score.score-updated,
    .individual-score.score-updated {
      animation: scoreUpdate 1.2s ease-out;
    }
    
    @keyframes scoreUpdate {
      0% {
        transform: scale(1);
        background: rgba(212,168,67,.10);
        border-color: rgba(212,168,67,.22);
        box-shadow: none;
      }
      20% {
        transform: scale(1.3);
        background: rgba(212,168,67,.35);
        border-color: rgba(212,168,67,.60);
        box-shadow: 0 0 30px rgba(212,168,67,.6);
      }
      40% {
        transform: scale(1.25);
        background: rgba(212,168,67,.30);
        border-color: rgba(212,168,67,.50);
        box-shadow: 0 0 25px rgba(212,168,67,.5);
      }
      60% {
        transform: scale(1.15);
        background: rgba(212,168,67,.25);
        border-color: rgba(212,168,67,.40);
        box-shadow: 0 0 20px rgba(212,168,67,.4);
      }
      100% {
        transform: scale(1);
        background: rgba(212,168,67,.10);
        border-color: rgba(212,168,67,.22);
        box-shadow: none;
      }
    }

    /* Player Name Emphasis Animation */
    .name.name-scored {
      animation: playerScored 1.5s ease-out;
    }
    
    @keyframes playerScored {
      0% {
        transform: scale(1);
        color: var(--text);
        text-shadow: none;
      }
      15% {
        transform: scale(1.2);
        color: var(--accent);
        text-shadow: 0 0 15px rgba(212,168,67,.8);
      }
      30% {
        transform: scale(1.15);
        color: #F5DCA0;
        text-shadow: 0 0 20px rgba(212,168,67,.9);
      }
      50% {
        transform: scale(1.1);
        color: var(--accent);
        text-shadow: 0 0 15px rgba(212,168,67,.7);
      }
      70% {
        transform: scale(1.05);
        color: #F5DCA0;
        text-shadow: 0 0 10px rgba(212,168,67,.5);
      }
      100% {
        transform: scale(1);
        color: var(--text);
        text-shadow: none;
      }
    }

    /* Enhanced Match box pulse animation */
    .match.match-updated {
      animation: matchPulse 1.2s ease-out;
    }

    @keyframes matchPulse {
      0% {
        border-color: rgba(212,168,67,.12);
        background: rgba(0,0,0,.30);
        transform: scale(1);
      }
      25% {
        border-color: rgba(212,168,67,.50);
        background: rgba(212,168,67,.15);
        box-shadow: 0 8px 40px rgba(212,168,67,.4);
        transform: scale(1.02);
      }
      50% {
        border-color: rgba(212,168,67,.40);
        background: rgba(212,168,67,.12);
        box-shadow: 0 6px 35px rgba(212,168,67,.3);
        transform: scale(1.01);
      }
      100% {
        border-color: rgba(212,168,67,.12);
        background: rgba(0,0,0,.30);
        box-shadow: none;
        transform: scale(1);
      }
    }
    table{
      width:100%;border-collapse:separate;border-spacing:0 8px;
      font-size:13px;
    }
    thead th{
      text-align:left;color:var(--accent);
      font-weight:700;font-size:12px;letter-spacing:.8px;text-transform:uppercase;
      padding:0 10px;
      position:sticky;top:0;z-index:2;
      background:linear-gradient(180deg, rgba(8,6,4,.95), rgba(8,6,4,.75));
      backdrop-filter: blur(6px);
    }
    tbody tr{
      background:rgba(0,0,0,.28);
      border:1px solid rgba(212,168,67,.08);
    }
    tbody td{
      padding:10px;border-top:1px solid rgba(255,255,255,.00);
      border-bottom:1px solid rgba(255,255,255,.00);
    }
    tbody tr td:first-child{border-radius:14px 0 0 14px}
    tbody tr td:last-child{border-radius:0 14px 14px 0}
    .rank{width:54px}
    .num{font-variant-numeric: tabular-nums}
    .qual{
      background:rgba(212,168,67,.06) !important;
      border:1px solid rgba(212,168,67,.22) !important;
    }
    .qual td{
      color:rgba(245,220,160,.9);
      font-weight:650;
    }
    .secure{
      background:linear-gradient(90deg, rgba(212,168,67,.12), rgba(212,168,67,.04) 60%) !important;
      border:2px solid rgba(212,168,67,.75) !important;
      box-shadow:0 0 16px rgba(212,168,67,.35);
    }
    .secure td{
      font-weight:800;
      color:#F5DCA0;
    }
    .secure td:first-child,
    .secure td:nth-child(2){
      color:#FFD770;
    }
    .standings-scroll{
      max-height:420px;
      min-height:700px;
      overflow:auto;
      scrollbar-width: thin;
      scrollbar-color: transparent transparent;
    }
    .standings-scroll:hover{
      scrollbar-color: rgba(212,168,67,.45) transparent;
    }
    .standings-scroll::-webkit-scrollbar{
      width:8px;
    }
    .standings-scroll::-webkit-scrollbar-track{
      background:transparent;
    }
    .standings-scroll::-webkit-scrollbar-thumb{
      background-color:transparent;
      border-radius:999px;
      border:2px solid transparent;
    }
    .standings-scroll:hover::-webkit-scrollbar-thumb{
      background-color:rgba(212,168,67,.45);
    }
    .cutline{
      margin-top:8px;padding:10px 12px;border-radius:14px;
      border:1px dashed rgba(212,168,67,.20);
      background:rgba(212,168,67,.03);
      color:var(--muted);font-size:12.5px
    }
    .bracket{
      display:grid;grid-template-columns: repeat(4, 1fr); gap:10px;
    }
    @media (max-width:980px){ .bracket{grid-template-columns:1fr 1fr} }
    @media (max-width:560px){ .bracket{grid-template-columns:1fr} }
    .col{
      border:1px solid rgba(212,168,67,.12);
      background:rgba(0,0,0,.25);
      border-radius:16px;padding:10px;
      min-height:160px;
    }
    .col h3{
      margin:0 0 8px;font-size:12px;letter-spacing:.8px;text-transform:uppercase;color:var(--accent)
    }
    .tile{
      border:1px solid rgba(212,168,67,.10);
      background:rgba(212,168,67,.03);
      border-radius:14px;padding:10px;margin-bottom:8px;
    }
    .tile:hover{border-color:rgba(212,168,67,.22)}
    .tile .m{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted)}
    .tile .p{display:flex;justify-content:space-between;gap:10px;margin-top:6px}
    .tile .p span:first-child{font-weight:650}
    .tiny{font-size:12px;color:var(--muted)}
    .footer{
      margin-top:14px;color:var(--muted);font-size:12px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{color:#F5DCA0}

    /* Sponsors Section */
    .sponsors-section{
      margin-top:20px;
      border:1px solid var(--line);border-radius:18px;
      background:linear-gradient(180deg, rgba(212,168,67,.04), rgba(212,168,67,.01));
      padding:20px;
    }
    .sponsors-title{
      margin:0 0 16px;font-size:13px;letter-spacing:.8px;text-transform:uppercase;
      color:var(--accent);text-align:center;
    }
    .sponsors-grid{
      display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;
    }
    .sponsor-card{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding:16px 10px;border-radius:14px;
      border:1px solid rgba(212,168,67,.12);
      background:rgba(0,0,0,.25);
      transition:border-color .2s, background .2s;
      text-align:center;
    }
    .sponsor-card:hover{
      border-color:rgba(212,168,67,.30);
      background:rgba(212,168,67,.06);
    }
    .sponsor-logo{
      width:100%;max-width:160px;border-radius:10px;
      display:block;margin:0 auto;
    }

    /* Enhanced Mobile Responsiveness */
    @media(max-width:640px){
      .wrap{padding:12px}
      .hero{flex-direction:column;text-align:center;padding:24px 16px;border-radius:18px;gap:20px;}
      .hero-decorative-left, .hero-decorative-right { width:60px; height:60px; }
      .hero-decorative-left { left:10px; }
      .hero-decorative-right { right:10px; }
      .hero-logo{width:68px;height:68px;font-size:26px;border-radius:18px}
      .hero-logo img{border-radius:18px}
      .hero-info h1{font-size:20px;letter-spacing:.6px}
      .hero-info .hero-sub{font-size:13px}
      .hero-venue{font-size:11px}
      .hero-badge{align-self:center;font-size:10px;padding:8px 16px}
      .topbar{
        flex-direction:column;align-items:stretch;
        padding:12px;border-radius:14px;gap:10px
      }
      .brand{justify-content:center}
      .badge{width:32px;height:32px;border-radius:10px;font-size:12px}
      .title h1{font-size:14px}
      .title p{font-size:11px}
      .controls{justify-content:center;gap:8px}
      .pill{padding:8px 10px;border-radius:12px}
      .pill label{font-size:11px}
      select, input{padding:6px 8px;font-size:13px;border-radius:10px}
      .status{font-size:11px;padding:6px 10px}
      .hero-right{align-items:center}
      .hero-status{font-size:11px;padding:6px 10px}
      .stage-tabs{justify-content:center}
      .grid{gap:12px;margin-top:12px}
      .card{border-radius:14px;padding:12px}
      .card h2{font-size:12px;flex-direction:column;align-items:flex-start;gap:4px}
      .subnote{font-size:11px}
      .match{border-radius:12px;padding:10px;min-height:100px}
      .setup{font-size:11px;padding:5px 8px}
      .roundtag{font-size:11px}
      .row{padding:6px 8px;border-radius:10px}
      .name{font-size:13px}
      .score{font-size:16px;padding:3px 8px;border-radius:10px;min-width:58px}
      .individual-score{font-size:20px;padding:3px 10px;border-radius:10px;min-width:42px}
      table{font-size:12px}
      thead th{font-size:11px;padding:0 6px}
      tbody td{padding:8px 6px}
      .cutline{font-size:11.5px;padding:8px 10px;border-radius:12px}
      .col{border-radius:12px;padding:8px;min-height:120px}
      .col h3{font-size:11px}
      .tile{border-radius:12px;padding:8px}
      .tile .m{font-size:11px}
      .tile .p{font-size:13px}
      .footer{font-size:11px}
      .sponsors-section{padding:14px;border-radius:14px;margin-top:14px}
      .sponsors-grid{grid-template-columns:repeat(2, 1fr);gap:10px}
      .sponsor-card{padding:10px 6px}
      .sponsor-logo{max-width:140px;border-radius:8px}
    }

    /* Extra small screens */
    @media(max-width:380px){
      .wrap{padding:8px}
      .hero{padding:14px 10px}
      .hero-info h1{font-size:16px}
      .controls{flex-direction:column;align-items:stretch}
      .pill{justify-content:center}
      .status{text-align:center}
      .sponsors-grid{grid-template-columns:repeat(2, 1fr);gap:8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Hero Banner -->
    <div class="hero">
      <!-- Decorative SVG Elements -->
      <div class="hero-decorative-left">
        <svg viewBox="0 0 80 80" fill="none">
          <path d="M40 10L46 28H66L50 40L56 58L40 46L24 58L30 40L14 28H34L40 10Z" fill="url(#goldGradient)" opacity="0.3"/>
          <defs>
            <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#F5DCA0"/>
              <stop offset="50%" style="stop-color:#D4A843"/>
              <stop offset="100%" style="stop-color:#B8952F"/>
            </linearGradient>
          </defs>
        </svg>
      </div>
      <div class="hero-decorative-right">
        <svg viewBox="0 0 80 80" fill="none">
          <circle cx="40" cy="40" r="25" fill="none" stroke="url(#goldGradient2)" stroke-width="2" opacity="0.4"/>
          <path d="M25 40C25 31.7 31.7 25 40 25M55 40C55 48.3 48.3 55 40 55M40 15V25M40 55V65M15 40H25M55 40H65" stroke="url(#goldGradient2)" stroke-width="1.5" opacity="0.3"/>
          <defs>
            <linearGradient id="goldGradient2" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#D4A843"/>
              <stop offset="100%" style="stop-color:#F5DCA0"/>
            </linearGradient>
          </defs>
        </svg>
      </div>
      
      <!-- Animated Stars -->
      <div class="hero-stars">
        <div class="hero-star"></div>
        <div class="hero-star"></div>
        <div class="hero-star"></div>
        <div class="hero-star"></div>
        <div class="hero-star"></div>
        <div class="hero-star"></div>
      </div>
      
      <div class="hero-logo">
        <img src="assets/sponsors/fresco.jpg" alt="Fresco Realty" />
      </div>
      <div class="hero-info">
        <h1>Fresco Cup — FIFA Tournament</h1>
        <div class="hero-sub"><b>Season 2</b> &nbsp;|&nbsp; PS5 &nbsp;|&nbsp; Toloba Taiyebi Mohallah, Pune</div>
        <div class="hero-venue">Jamali Hall &bull; Taiyebi Masjid Burhani Colony &bull; Presented by Fresco Realty</div>
      </div>
      <div class="hero-right">
        <div class="hero-badge"><span>Live Dashboard</span></div>
        <div class="hero-status" id="status">Status: <b>Loading…</b></div>
      </div>
    </div>

    <div class="stage-tabs" id="stageTabs">
      <button class="stage-tab active" data-stage="league">League</button>
      <button class="stage-tab" data-stage="playins">Play Ins</button>
      <button class="stage-tab" data-stage="quarters">Quater Finals</button>
      <button class="stage-tab" data-stage="semis">Semi Finals</button>
      <button class="stage-tab" data-stage="final">Final</button>
      <button class="stage-tab" data-scroll="standingsSection">Standings</button>
      <button class="stage-tab" data-stage="player">Player Matches</button>
    </div>

    <div class="stage-panel active" id="stage-league">
      <div class="card">
        <div class="card-head">
          <h2>
            <span>League Stage</span>
          </h2>
          <div class="pill">
            <label for="roundSelect">Round</label>
            <select id="roundSelect"></select>
          </div>
        </div>
        <div class="matches" id="nowPlaying"></div>

        <div class="footer">
          <div>Tip: change <b>Round</b> to control what’s on TV.</div>
          <div class="tiny">Refresh: every 5s</div>
        </div>
      </div>
    </div>

    <div class="stage-panel" id="stage-playins">
      <div class="card">
        <h2>
          <span>Play Ins</span>
          <span class="subnote">Top 2 protected • Seeds 3–14 play-in</span>
        </h2>
        <div class="matches" id="playinCol"></div>
      </div>
    </div>

    <div class="stage-panel" id="stage-quarters">
      <div class="card">
        <h2>
          <span>Quater Finals</span>
          <span class="subnote">Knockout stage</span>
        </h2>
        <div class="matches" id="qfCol"></div>
      </div>
    </div>

    <div class="stage-panel" id="stage-semis">
      <div class="card">
        <h2>
          <span>Semi Finals</span>
          <span class="subnote">Knockout stage</span>
        </h2>
        <div class="matches" id="sfCol"></div>
      </div>
    </div>

    <div class="stage-panel" id="stage-final">
      <div class="card">
        <h2>
          <span>Final</span>
          <span class="subnote">Championship match</span>
        </h2>
        <div class="matches" id="finalCol"></div>
      </div>
    </div>

    <div class="stage-panel" id="stage-player">
      <div class="card">
        <div class="card-head">
          <h2>
            <span>Player Matches</span>
          </h2>
          <div class="pill">
            <label for="playerSelect">Player</label>
            <select id="playerSelect"></select>
          </div>
        </div>
        <div class="matches" id="playerMatches"></div>
      </div>
    </div>

    <div class="card" id="standingsSection" style="margin-top:16px">
      <h2>
        <span>Live Standings</span>
        <span class="subnote">All ranks</span>
      </h2>
      <div class="standings-scroll">
        <table>
          <thead>
            <tr>
              <th class="rank">#</th>
              <th>name</th>
              <th class="num">P</th>
              <th class="num">W</th>
              <th class="num">D</th>
              <th class="num">L</th>
              <th class="num">GD</th>
              <th class="num">Points</th>
            </tr>
          </thead>
          <tbody id="standingsBody"></tbody>
        </table>
      </div>
      <div class="cutline" id="cutline"></div>
      <div class="footer">
        <div class="tiny">Fresco Cup Season 2</div>
        <div class="tiny" id="lastUpdated">—</div>
      </div>
    </div>

    <!-- Sponsors Section -->
    <div class="sponsors-section">
      <h2 class="sponsors-title">Our Sponsors</h2>
      <div class="sponsors-grid">
        <div class="sponsor-card">
          <img class="sponsor-logo" src="assets/sponsors/divine-caterers.png" alt="Divine Caterers" />
        </div>
        <div class="sponsor-card">
          <img class="sponsor-logo" src="assets/sponsors/juice-53.png" alt="Juice 53" />
        </div>
        <div class="sponsor-card">
          <img class="sponsor-logo" src="assets/sponsors/kfarid.png" alt="KFarid Events" />
        </div>
        <div class="sponsor-card">
          <img class="sponsor-logo" src="assets/sponsors/premium.png" alt="Premium" />
        </div>
        <div class="sponsor-card">
          <img class="sponsor-logo" src="assets/sponsors/visionary-services.png" alt="Visionary Services" />
        </div>
        <div class="sponsor-card">
          <img class="sponsor-logo" src="assets/sponsors/tall-guy.png" alt="Tall Guy" />
        </div>
      </div>
    </div>
  </div>

  <div class="popup-overlay" id="finalPopup">
    <div class="popup">
      <button class="popup-close" id="finalPopupClose" aria-label="Close">✕</button>
      <div class="confetti" id="finalConfetti"></div>
      <h3>Champion</h3>
      <div class="winner" id="finalWinner">—</div>
      <div class="runner" id="finalRunner">Runner-up: —</div>
    </div>
  </div>

<script>
  const API_BASE = "https://script.google.com/macros/s/AKfycbx9setn6rPa0559junEvAL5tjMydjNdi3WHeeQMUAgyuIJ1c91lA8qjVttjfOp92sY5Kw/exec";
  const REFRESH_MS = 5000;

  const elStatus = document.getElementById("status");
  const elRoundSelect = document.getElementById("roundSelect");

  const elNow = document.getElementById("nowPlaying");
  const elStand = document.getElementById("standingsBody");
  const elCutline = document.getElementById("cutline");
  const elStageTabs = document.getElementById("stageTabs");
  const elStagePanels = document.querySelectorAll(".stage-panel");
  const elPlayerSelect = document.getElementById("playerSelect");
  const elPlayerMatches = document.getElementById("playerMatches");
  const elFinalPopup = document.getElementById("finalPopup");
  const elFinalPopupClose = document.getElementById("finalPopupClose");
  const elFinalWinner = document.getElementById("finalWinner");
  const elFinalRunner = document.getElementById("finalRunner");
  const elFinalConfetti = document.getElementById("finalConfetti");

  const elPlayIn = document.getElementById("playinCol");
  const elQF = document.getElementById("qfCol");
  const elSF = document.getElementById("sfCol");
  const elFinal = document.getElementById("finalCol");
  const elLast = document.getElementById("lastUpdated");

  // Store previous scores for animation detection
  let previousScores = new Map();
  let previousIndividualScores = new Map(); // Track individual player scores
  let previousPlayoffScores = new Map();
  let previousPlayoffIndividualScores = new Map();
  let latestMatches = [];
  let latestPlayoffs = [];
  let finalPopupShown = false;

  function normKey(k){
    return String(k || "").trim().toLowerCase();
  }
  function get(obj, key){
    const target = normKey(key);
    for (const k of Object.keys(obj || {})){
      if (normKey(k) === target) return obj[k];
    }
    return "";
  }
  function safeStr(v){ return (v===null || v===undefined) ? "" : String(v).trim(); }
  function penaltyVal(r, side){
    const key = side === "A" ? "A" : "B";
    return safeStr(
      get(r, `Pens ${key}`) ||
      get(r, `Pen ${key}`) ||
      get(r, `Penalty ${key}`) ||
      get(r, `Penalties ${key}`)
    );
  }

  async function fetchSheet(name){
    const url = API_BASE + "?sheet=" + encodeURIComponent(name);
    const res = await fetch(url, { cache:"no-store" });
    if (!res.ok) throw new Error("Fetch failed: " + name);
    return await res.json();
  }

  function setStatus(ok, msg){
    elStatus.innerHTML = `Status: <b style="color:${ok ? 'var(--good)' : 'var(--bad)'}">${msg}</b>`;
  }

  function roundOptionsFromMatches(matches){
    const rounds = new Set();
    matches.forEach(m => {
      const r = parseInt(get(m,"Round") || get(m,"round") || get(m,"ROUND") || 0, 10);
      if (r) rounds.add(r);
    });
    return Array.from(rounds).sort((a,b)=>a-b);
  }

  function renderRoundSelect(rounds, suggested){
    elRoundSelect.innerHTML = "";
    rounds.forEach(r=>{
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = "Round " + r;
      if (r === suggested) opt.selected = true;
      elRoundSelect.appendChild(opt);
    });
  }

  function inferBestRound(matches){
    // Choose the lowest round that still has any unplayed match; else max round.
    const byRound = new Map();
    matches.forEach(m=>{
      const r = parseInt(get(m,"Round"),10) || 0;
      if (!r) return;
      if (!byRound.has(r)) byRound.set(r, []);
      byRound.get(r).push(m);
    });
    const rounds = Array.from(byRound.keys()).sort((a,b)=>a-b);
    for (const r of rounds){
      const list = byRound.get(r) || [];
      const anyUnplayed = list.some(m => {
        const played = get(m,"Played");
        return String(played).trim() !== "1" && String(played).trim().toLowerCase() !== "true";
      });
      if (anyUnplayed) return r;
    }
    return rounds[rounds.length-1] || 1;
  }

  function winnerBadge(isWinner){
    return isWinner ? `<span class="winner-badge">W</span>` : "";
  }

  function cardMatch({setup, round, a, b, ga, gb, isScoreUpdated, playerAScored, playerBScored, winnerA, winnerB}){
    // Individual scores for each player
    const scoreA = ga !== "" ? ga : "—";
    const scoreB = gb !== "" ? gb : "—";
    
    const matchAnimClass = isScoreUpdated ? "match-updated" : "";
    
    // Only animate the name of the player who actually scored
    const playerAAnimClass = playerAScored ? "name-scored" : "";
    const playerBAnimClass = playerBScored ? "name-scored" : "";
    
    // Animation for individual scores
    const scoreAAnimClass = playerAScored ? "score-updated" : "";
    const scoreBAnimClass = playerBScored ? "score-updated" : "";
    
    return `
      <div class="match ${matchAnimClass}" data-setup="${setup}">
        <div class="match-top">
          <div class="setup">${setup}</div>
          <div class="roundtag">Round ${round}</div>
        </div>
        <div class="row">
          <div class="name ${playerAAnimClass}">${escapeHtml(a || "TBD")}${winnerBadge(winnerA)}</div>
          <div class="individual-score ${scoreAAnimClass}">${scoreA}</div>
        </div>
        <div class="row">
          <div class="name ${playerBAnimClass}">${escapeHtml(b || "TBD")}${winnerBadge(winnerB)}</div>
          <div class="individual-score ${scoreBAnimClass}">${scoreB}</div>
        </div>
      </div>
    `;
  }

  function cardPlayoff({stageLabel, stageClass, matchLabel, a, b, ga, gb, pa, pb, isScoreUpdated, playerAScored, playerBScored, winnerA, winnerB}){
    const penA = safeStr(pa);
    const penB = safeStr(pb);
    const scoreA = ga !== "" ? `${ga}${penA !== "" ? ` (${penA})` : ""}` : "—";
    const scoreB = gb !== "" ? `${gb}${penB !== "" ? ` (${penB})` : ""}` : "—";

    const matchAnimClass = isScoreUpdated ? "match-updated" : "";
    const playerAAnimClass = playerAScored ? "name-scored" : "";
    const playerBAnimClass = playerBScored ? "name-scored" : "";
    const scoreAAnimClass = playerAScored ? "score-updated" : "";
    const scoreBAnimClass = playerBScored ? "score-updated" : "";

    return `
      <div class="match ${stageClass || ""} ${matchAnimClass}" data-setup="${escapeHtml(matchLabel)}">
        <div class="match-top">
          <div class="setup">${escapeHtml(stageLabel)}</div>
          <div class="roundtag">${escapeHtml(matchLabel)}</div>
        </div>
        <div class="row">
          <div class="name ${playerAAnimClass}">${escapeHtml(a || "TBD")}${winnerBadge(winnerA)}</div>
          <div class="individual-score ${scoreAAnimClass}">${scoreA}</div>
        </div>
        <div class="row">
          <div class="name ${playerBAnimClass}">${escapeHtml(b || "TBD")}${winnerBadge(winnerB)}</div>
          <div class="individual-score ${scoreBAnimClass}">${scoreB}</div>
        </div>
      </div>
    `;
  }

  function playerSetFromData(matches, playoffs){
    const players = new Set();
    matches.forEach(m=>{
      const a = safeStr(get(m,"Player A")) || safeStr(get(m,"PlayerA")) || safeStr(get(m,"Player A "));
      const b = safeStr(get(m,"Player B")) || safeStr(get(m,"PlayerB")) || safeStr(get(m,"Player B "));
      if (a) players.add(a);
      if (b) players.add(b);
    });
    playoffs.forEach(r=>{
      const a = safeStr(get(r,"Player A"));
      const b = safeStr(get(r,"Player B"));
      if (a) players.add(a);
      if (b) players.add(b);
    });
    return Array.from(players).sort((a,b)=>a.localeCompare(b));
  }

  function renderPlayerSelect(matches, playoffs){
    if (!elPlayerSelect) return;
    const players = playerSetFromData(matches, playoffs);
    const current = elPlayerSelect.value;
    elPlayerSelect.innerHTML = "";
    players.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      elPlayerSelect.appendChild(opt);
    });
    if (current && players.includes(current)){
      elPlayerSelect.value = current;
    } else if (players.length){
      elPlayerSelect.value = players[0];
    }
  }

  function stageLabelFromStage(stage){
    if (stage.includes("play")) return "Play-In";
    if (stage === "qf" || stage.includes("quarter")) return "Quarter Finals";
    if (stage === "sf" || stage.includes("semi")) return "Semi Finals";
    if (stage.includes("final")) return "Final";
    return "Playoffs";
  }
  function stageClassFromStage(stage){
    if (stage.includes("play")) return "playin";
    if (stage === "qf" || stage.includes("quarter")) return "quarters";
    if (stage === "sf" || stage.includes("semi")) return "semis";
    if (stage.includes("final")) return "final";
    return "";
  }

  function showFinalPopup(winner, runnerUp){
    if (!elFinalPopup) return;
    elFinalWinner.textContent = winner || "TBD";
    elFinalRunner.textContent = `Runner-up: ${runnerUp || "TBD"}`;
    buildConfetti(elFinalConfetti, 120);
    elFinalPopup.classList.add("show");
  }
  function buildConfetti(container, count){
    if (!container) return;
    container.innerHTML = "";
    const colors = ["#F5DCA0","#D4A843","#FFFFFF","#FFD770","#C49B3A"];
    for (let i=0;i<count;i++){
      const s = document.createElement("span");
      const x = Math.random()*100;
      const d = (3.0 + Math.random()*2.6).toFixed(2) + "s";
      const d2 = (1.8 + Math.random()*1.6).toFixed(2) + "s";
      const r = Math.floor(Math.random()*220) + "deg";
      const c = colors[i % colors.length];
      const w = 6 + Math.floor(Math.random()*8);
      const h = 10 + Math.floor(Math.random()*12);
      const delay = (Math.random()*2.5).toFixed(2) + "s";
      s.style.left = x + "%";
      s.style.setProperty("--x", (Math.random()*40 - 20) + "px");
      s.style.setProperty("--d", d);
      s.style.setProperty("--d2", d2);
      s.style.setProperty("--r", r);
      s.style.setProperty("--c", c);
      s.style.width = w + "px";
      s.style.height = h + "px";
      s.style.borderRadius = Math.random() > 0.6 ? "50%" : "3px";
      s.style.animationDelay = "-" + delay;
      container.appendChild(s);
    }
  }

  function renderPlayerMatches(matches, playoffs, playerName){
    if (!elPlayerMatches) return;
    const target = safeStr(playerName);
    if (!target){
      elPlayerMatches.innerHTML = `<div class="tiny">Select a player to view matches</div>`;
      return;
    }
    const list = [];

    matches.forEach(m=>{
      const a = safeStr(get(m,"Player A")) || safeStr(get(m,"PlayerA")) || safeStr(get(m,"Player A "));
      const b = safeStr(get(m,"Player B")) || safeStr(get(m,"PlayerB")) || safeStr(get(m,"Player B "));
      if (!a && !b) return;
      if (a !== target && b !== target) return;
      const round = safeStr(get(m,"Round"));
      const setup = safeStr(get(m,"Setup"));
      const ga = safeStr(get(m,"Goals A"));
      const gb = safeStr(get(m,"Goals B"));
      const matchLabel = round ? `Round ${round}${setup ? " • " + setup : ""}` : (setup || "League Match");
      const roundNum = parseInt(round, 10) || 0;
      const gaNum = ga !== "" ? parseInt(ga, 10) : NaN;
      const gbNum = gb !== "" ? parseInt(gb, 10) : NaN;
      const winnerA = Number.isFinite(gaNum) && Number.isFinite(gbNum) && gaNum > gbNum;
      const winnerB = Number.isFinite(gaNum) && Number.isFinite(gbNum) && gbNum > gaNum;
      list.push({
        stageLabel: "League",
        matchLabel,
        a,
        b,
        ga,
        gb,
        pa: "",
        pb: "",
        isScoreUpdated: false,
        playerAScored: false,
        playerBScored: false,
        winnerA,
        winnerB,
        sortKey: 0 * 1000 + roundNum
      });
    });

    playoffs.forEach(r=>{
      const stage = normKey(get(r,"Stage"));
      const match = safeStr(get(r,"Match"));
      const a = safeStr(get(r,"Player A"));
      const b = safeStr(get(r,"Player B"));
      if (!a && !b) return;
      if (a !== target && b !== target) return;
      const ga = safeStr(get(r,"Goals A"));
      const gb = safeStr(get(r,"Goals B"));
      const pa = penaltyVal(r, "A");
      const pb = penaltyVal(r, "B");
      const winner = safeStr(get(r,"Winner"));
      const stageLabel = stageLabelFromStage(stage);
      const stageClass = stageClassFromStage(stage);
      const matchLabel = match ? `Match ${match}` : "Match";
      const matchNum = parseInt(match, 10) || 0;
      const stageRank = stage.includes("play")
        ? 1
        : (stage === "qf" || stage.includes("quarter"))
          ? 2
          : (stage === "sf" || stage.includes("semi"))
            ? 3
            : (stage.includes("final") ? 4 : 1);
      const gaNum = ga !== "" ? parseInt(ga, 10) : NaN;
      const gbNum = gb !== "" ? parseInt(gb, 10) : NaN;
      const winnerA = (winner && winner === a) || (!winner && Number.isFinite(gaNum) && Number.isFinite(gbNum) && gaNum > gbNum);
      const winnerB = (winner && winner === b) || (!winner && Number.isFinite(gaNum) && Number.isFinite(gbNum) && gbNum > gaNum);
      list.push({
        stageLabel,
        stageClass,
        matchLabel,
        a,
        b,
        ga,
        gb,
        pa,
        pb,
        isScoreUpdated: false,
        playerAScored: false,
        playerBScored: false,
        winnerA,
        winnerB,
        sortKey: stageRank * 1000 + matchNum
      });
    });

    if (!list.length){
      elPlayerMatches.innerHTML = `<div class="tiny">No matches found for ${escapeHtml(target)}</div>`;
      return;
    }

    list.sort((a,b) => (b.sortKey || 0) - (a.sortKey || 0));
    elPlayerMatches.innerHTML = list.map(x=>cardPlayoff(x)).join("");
  }

  function renderNowPlaying(matches, round){
    const setups = ["Setup 1","Setup 2","Setup 3","Setup 4"];
    const roundMatches = matches.filter(m => String(get(m,"Round")) === String(round));

    const html = setups.map((s, index)=>{
      const m = roundMatches.find(x => normKey(get(x,"Setup")) === normKey(s));
      if (!m){
        return cardMatch({setup:s, round, a:"—", b:"—", ga:"", gb:"", isScoreUpdated: false, playerAScored: false, playerBScored: false});
      }

      const ga = safeStr(get(m,"Goals A"));
      const gb = safeStr(get(m,"Goals B"));
      
      const currentScore = (ga !== "" && gb !== "") ? `${ga}-${gb}` : "";
      const setupKey = `${round}-${s}`;
      const previousScore = previousScores.get(setupKey) || "";
      
      // Track individual scores to determine who scored
      const currentGa = ga !== "" ? parseInt(ga, 10) || 0 : 0;
      const currentGb = gb !== "" ? parseInt(gb, 10) || 0 : 0;
      const prevScores = previousIndividualScores.get(setupKey) || {ga: 0, gb: 0};
      const previousGa = prevScores.ga;
      const previousGb = prevScores.gb;
      
      // Check if score changed (and it's not the first load)
      const isScoreUpdated = currentScore !== "" && previousScore !== "" && currentScore !== previousScore;
      
      // Determine who actually scored (whose score increased)
      const playerAScored = isScoreUpdated && currentGa > previousGa;
      const playerBScored = isScoreUpdated && currentGb > previousGb;
      
      // Update stored scores
      previousScores.set(setupKey, currentScore);
      previousIndividualScores.set(setupKey, {ga: currentGa, gb: currentGb});

      const gaNum = ga !== "" ? parseInt(ga, 10) : NaN;
      const gbNum = gb !== "" ? parseInt(gb, 10) : NaN;
      const winnerA = Number.isFinite(gaNum) && Number.isFinite(gbNum) && gaNum > gbNum;
      const winnerB = Number.isFinite(gaNum) && Number.isFinite(gbNum) && gbNum > gaNum;

      return cardMatch({
        setup: s,
        round,
        a: safeStr(get(m,"Player A")) || safeStr(get(m,"PlayerA")) || safeStr(get(m,"Player A ")),
        b: safeStr(get(m,"Player B")) || safeStr(get(m,"PlayerB")) || safeStr(get(m,"Player B ")),
        ga: ga,
        gb: gb,
        isScoreUpdated: isScoreUpdated,
        playerAScored: playerAScored,
        playerBScored: playerBScored,
        winnerA,
        winnerB
      });
    }).join("");

    elNow.innerHTML = html;
    
    // Clean up animation classes after animation completes
    setTimeout(() => {
      const animatedElements = elNow.querySelectorAll('.score-updated, .match-updated, .name-scored');
      animatedElements.forEach(el => {
        el.classList.remove('score-updated', 'match-updated', 'name-scored');
      });
    }, 1500); // Match the longest animation duration
  }

  function renderStandings(rows){
    const cutoff = 14;

    // Expect Rank / Player / Pts, but handle odd headers from sheet response
    const cleaned = rows
      .map(r => {
        const numericKey = Object.keys(r || {}).find(k => k.trim() !== "" && !Number.isNaN(Number(k)));
        const rankFromNumeric = numericKey ? parseInt(numericKey, 10) : NaN;
        const rankFromField = parseInt(
          get(r,"Rank") || get(r,"rank") || get(r,"Playoff cutoff (Top N)") || "",
          10
        );
        return {
          rank: Number.isFinite(rankFromField)
            ? rankFromField
            : (Number.isFinite(rankFromNumeric) ? rankFromNumeric : 9999),
          player: safeStr(get(r,"Player") || get(r,"Name") || (numericKey ? r[numericKey] : "")),
          p: get(r,"P") || get(r,"Played") || get(r,"Matches") || get(r,"MP") || "0",
          w: get(r,"W") || get(r,"Won") || get(r,"Wins") || "0",
          d: get(r,"D") || get(r,"Draw") || get(r,"Drawn") || get(r,"Draws") || "0",
          l: get(r,"L") || get(r,"Lost") || get(r,"Loss") || get(r,"Losses") || "0",
          pts: get(r,"Pts") || get(r,"PTS") || get(r,"Points") || get(r,"points") || get(r,"") || "0",
          gd: get(r,"GD") || get(r,"Gd") || get(r,"gd") || get(r,"Goal Difference") || get(r,"Goal difference") || get(r,"goal difference") || "0"
        };
      })
      .filter(x => x.player)
      .sort((a,b)=>a.rank-b.rank);

    elStand.innerHTML = cleaned.map(x => {
      const isSecure = x.rank <= 2;
      const isQual = x.rank <= cutoff && !isSecure;
      const rowClass = isSecure ? "secure" : (isQual ? "qual" : "");
      return `
        <tr class="${rowClass}">
          <td class="rank num">${x.rank}</td>
          <td>${escapeHtml(x.player)}</td>
          <td class="num">${escapeHtml(String(x.p ?? ""))}</td>
          <td class="num">${escapeHtml(String(x.w ?? ""))}</td>
          <td class="num">${escapeHtml(String(x.d ?? ""))}</td>
          <td class="num">${escapeHtml(String(x.l ?? ""))}</td>
          <td class="num">${escapeHtml(String(x.gd ?? ""))}</td>
          <td class="num"><b>${escapeHtml(String(x.pts ?? ""))}</b></td>
        </tr>
      `;
    }).join("");

    elCutline.textContent = `Qualification: Top ${cutoff}. Top 1–2 secure • Ranks 3–${cutoff} qualified.`;
  }

  function renderPlayoffs(rows){
    // Expect Stage, Match, Player A, Goals A, Pens A, Player B, Goals B, Pens B, Winner
    const playin = [];
    const qf = [];
    const sf = [];
    const fin = [];
    let finalResult = null;

    rows.forEach(r=>{
      const stage = normKey(get(r,"Stage"));
      const match = safeStr(get(r,"Match"));
      const a = safeStr(get(r,"Player A"));
      const b = safeStr(get(r,"Player B"));
      const ga = safeStr(get(r,"Goals A"));
      const gb = safeStr(get(r,"Goals B"));
      const pa = penaltyVal(r, "A");
      const pb = penaltyVal(r, "B");
      const winner = safeStr(get(r,"Winner"));
      const stageLabel = stage.includes("play")
        ? "Play-In"
        : (stage === "qf" || stage.includes("quarter"))
          ? "Quarter Finals"
          : (stage === "sf" || stage.includes("semi"))
            ? "Semi Finals"
            : (stage.includes("final") ? "Final" : "Playoffs");
      const stageClass = stageClassFromStage(stage);
      const matchLabel = match ? `Match ${match}` : "Match";
      const matchKey = `playoff-${stageLabel}-${matchLabel}-${a}-${b}`;

      const currentScore = (ga !== "" && gb !== "") ? `${ga}-${gb}` : "";
      const previousScore = previousPlayoffScores.get(matchKey) || "";
      const currentGa = ga !== "" ? parseInt(ga, 10) || 0 : 0;
      const currentGb = gb !== "" ? parseInt(gb, 10) || 0 : 0;
      const prevScores = previousPlayoffIndividualScores.get(matchKey) || {ga: 0, gb: 0};
      const previousGa = prevScores.ga;
      const previousGb = prevScores.gb;
      const isScoreUpdated = currentScore !== "" && previousScore !== "" && currentScore !== previousScore;
      const playerAScored = isScoreUpdated && currentGa > previousGa;
      const playerBScored = isScoreUpdated && currentGb > previousGb;

      previousPlayoffScores.set(matchKey, currentScore);
      previousPlayoffIndividualScores.set(matchKey, {ga: currentGa, gb: currentGb});

      // Skip "Protected" lines if they exist as non-matches
      if (stage.includes("protected")) return;

      const winnerA = winner && winner === a;
      const winnerB = winner && winner === b;
      const payload = {
        stageLabel,
        stageClass,
        matchLabel,
        a,
        b,
        ga,
        gb,
        pa,
        pb,
        isScoreUpdated,
        playerAScored,
        playerBScored,
        winnerA,
        winnerB
      };

      if (stage.includes("play")) playin.push(payload);
      else if (stage === "qf" || stage.includes("quarter")) qf.push(payload);
      else if (stage === "sf" || stage.includes("semi")) sf.push(payload);
      else if (stage.includes("final") || match.toLowerCase()==="f") fin.push(payload);

      if (!finalResult && (stage.includes("final") || match.toLowerCase()==="f")){
        const gaNum = ga !== "" ? parseInt(ga, 10) : NaN;
        const gbNum = gb !== "" ? parseInt(gb, 10) : NaN;
        let resolvedWinner = winner;
        let runnerUp = "";
        if (!resolvedWinner && Number.isFinite(gaNum) && Number.isFinite(gbNum) && a && b){
          if (gaNum > gbNum) resolvedWinner = a;
          else if (gbNum > gaNum) resolvedWinner = b;
        }
        if (resolvedWinner){
          runnerUp = resolvedWinner === a ? b : a;
          finalResult = {winner: resolvedWinner, runnerUp: runnerUp || ""};
        }
      }
    });

    elPlayIn.innerHTML = playin.length ? playin.map(x=>cardPlayoff(x)).join("") : `<div class="tiny">Play-in not started</div>`;
    elQF.innerHTML     = qf.length     ? qf.map(x=>cardPlayoff(x)).join("") : `<div class="tiny">Quarter Finals not started</div>`;
    elSF.innerHTML     = sf.length     ? sf.map(x=>cardPlayoff(x)).join("") : `<div class="tiny">Semi Finals not started</div>`;
    elFinal.innerHTML  = fin.length    ? fin.map(x=>cardPlayoff(x)).join("") : `<div class="tiny">Final not started</div>`;

    if (finalResult && !finalPopupShown){
      showFinalPopup(finalResult.winner, finalResult.runnerUp);
      finalPopupShown = true;
    }

  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function refresh(){
    try{
      setStatus(true, "Loading…");

      const [matches, standings, playoffs] = await Promise.all([
        fetchSheet("Matches"),
        fetchSheet("Standings"),
        fetchSheet("Playoffs"),
      ]);
      latestMatches = matches;
      latestPlayoffs = playoffs;

      // round selector init
      const rounds = roundOptionsFromMatches(matches);
      if (!elRoundSelect.options.length){
        const suggested = inferBestRound(matches);
        renderRoundSelect(rounds, suggested);
      }

      const round = parseInt(elRoundSelect.value || rounds[0] || 1, 10);

      renderNowPlaying(matches, round);
      renderStandings(standings);
      renderPlayoffs(playoffs);
      renderPlayerSelect(matches, playoffs);
      if (elPlayerSelect && elPlayerSelect.value){
        renderPlayerMatches(matches, playoffs, elPlayerSelect.value);
      }

      const now = new Date();
      elLast.textContent = "Last updated: " + now.toLocaleTimeString();
      setStatus(true, "Live");
    }catch(err){
      console.error(err);
      setStatus(false, "API error");
    }
  }

  // refresh on changes
  elRoundSelect.addEventListener("change", refresh);
  if (elPlayerSelect){
    elPlayerSelect.addEventListener("change", () => {
      renderPlayerMatches(latestMatches, latestPlayoffs, elPlayerSelect.value);
    });
  }

  // stage tab switching
  if (elStageTabs){
    elStageTabs.addEventListener("click", (e) => {
      const btn = e.target.closest(".stage-tab");
      if (!btn) return;
      const scrollTarget = btn.getAttribute("data-scroll");
      if (scrollTarget){
        const el = document.getElementById(scrollTarget);
        if (el) el.scrollIntoView({behavior:"smooth", block:"start"});
        return;
      }
      const stage = btn.getAttribute("data-stage");
      if (!stage) return;
      elStageTabs.querySelectorAll(".stage-tab").forEach(b => b.classList.toggle("active", b === btn));
      elStagePanels.forEach(panel => {
        panel.classList.toggle("active", panel.id === `stage-${stage}`);
      });
    });
  }
  if (elFinalPopup){
    elFinalPopup.addEventListener("click", (e) => {
      if (e.target === elFinalPopup) elFinalPopup.classList.remove("show");
    });
  }
  if (elFinalPopupClose){
    elFinalPopupClose.addEventListener("click", () => elFinalPopup.classList.remove("show"));
  }

  refresh();
  setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
